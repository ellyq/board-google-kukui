From b02598fbe95c4821af19df4f5489931651a1f463 Mon Sep 17 00:00:00 2001
From: Alicja Michalska <ahplka19@gmail.com>
Date: Wed, 22 Nov 2023 12:15:41 +0100
Subject: [PATCH 03/11] dts/mt/mt8183: Add clocks for Mali-G72 (bifrost) GPU,
 fix opp tables.

Signed-off-by: Alicja Michalska <ahplka19@gmail.com>
---
 arch/arm64/boot/dts/mediatek/mt8183.dtsi | 183 +++++++++++++----------
 1 file changed, 108 insertions(+), 75 deletions(-)

diff --git a/arch/arm64/boot/dts/mediatek/mt8183.dtsi b/arch/arm64/boot/dts/mediatek/mt8183.dtsi
index e0c4c2357a4e..d1ffdf6cdd71 100644
--- a/arch/arm64/boot/dts/mediatek/mt8183.dtsi
+++ b/arch/arm64/boot/dts/mediatek/mt8183.dtsi
@@ -558,9 +558,10 @@ l2_1: l2-cache1 {
 	};
 
 	gpu_opp_table: opp-table-0 {
-		compatible = "operating-points-v2";
+		compatible = "operating-points-v2", "operating-points-v2-mali";
 		opp-shared;
 
+<<<<<<< HEAD
 		opp-300000000 {
 			opp-hz = /bits/ 64 <300000000>;
 			opp-microvolt = <625000>;
@@ -660,82 +661,104 @@ opp-800000000 {
 				opp-core-mask = /bits/ 64 <0xf>;
 			};
 		};
+=======
+			opp-300000000 {
+				opp-hz = /bits/ 64 <300000000>;
+				opp-microvolt = <625000>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
+>>>>>>> 32280bb8e020 (dts/mt/mt8183: Add clocks for Mali-G72 (bifrost) GPU, fix opp tables.)
 
-		opp-320000000 {
-			opp-hz = /bits/ 64 <320000000>;
-			opp-microvolt = <631250>;
-		};
+			opp-320000000 {
+				opp-hz = /bits/ 64 <320000000>;
+				opp-microvolt = <631250>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-340000000 {
-			opp-hz = /bits/ 64 <340000000>;
-			opp-microvolt = <637500>;
-		};
+			opp-340000000 {
+				opp-hz = /bits/ 64 <340000000>;
+				opp-microvolt = <637500>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-360000000 {
-			opp-hz = /bits/ 64 <360000000>;
-			opp-microvolt = <643750>;
-		};
+			opp-360000000 {
+				opp-hz = /bits/ 64 <360000000>;
+				opp-microvolt = <643750>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-380000000 {
-			opp-hz = /bits/ 64 <380000000>;
-			opp-microvolt = <650000>;
-		};
+			opp-380000000 {
+				opp-hz = /bits/ 64 <380000000>;
+				opp-microvolt = <650000>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-400000000 {
-			opp-hz = /bits/ 64 <400000000>;
-			opp-microvolt = <656250>;
-		};
+			opp-400000000 {
+				opp-hz = /bits/ 64 <400000000>;
+				opp-microvolt = <656250>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-420000000 {
-			opp-hz = /bits/ 64 <420000000>;
-			opp-microvolt = <662500>;
-		};
+			opp-420000000 {
+				opp-hz = /bits/ 64 <420000000>;
+				opp-microvolt = <662500>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-460000000 {
-			opp-hz = /bits/ 64 <460000000>;
-			opp-microvolt = <675000>;
-		};
+			opp-460000000 {
+				opp-hz = /bits/ 64 <460000000>;
+				opp-microvolt = <675000>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-500000000 {
-			opp-hz = /bits/ 64 <500000000>;
-			opp-microvolt = <687500>;
-		};
+			opp-500000000 {
+				opp-hz = /bits/ 64 <500000000>;
+				opp-microvolt = <687500>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-540000000 {
-			opp-hz = /bits/ 64 <540000000>;
-			opp-microvolt = <700000>;
-		};
+			opp-540000000 {
+				opp-hz = /bits/ 64 <540000000>;
+				opp-microvolt = <700000>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-580000000 {
-			opp-hz = /bits/ 64 <580000000>;
-			opp-microvolt = <712500>;
-		};
+			opp-580000000 {
+				opp-hz = /bits/ 64 <580000000>;
+				opp-microvolt = <712500>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-620000000 {
-			opp-hz = /bits/ 64 <620000000>;
-			opp-microvolt = <725000>;
-		};
+			opp-620000000 {
+				opp-hz = /bits/ 64 <620000000>;
+				opp-microvolt = <725000>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-653000000 {
-			opp-hz = /bits/ 64 <653000000>;
-			opp-microvolt = <743750>;
-		};
+			opp-653000000 {
+				opp-hz = /bits/ 64 <653000000>;
+				opp-microvolt = <743750>, <850000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-698000000 {
-			opp-hz = /bits/ 64 <698000000>;
-			opp-microvolt = <768750>;
-		};
+			opp-698000000 {
+				opp-hz = /bits/ 64 <698000000>;
+				opp-microvolt = <768750>, <868750>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-743000000 {
-			opp-hz = /bits/ 64 <743000000>;
-			opp-microvolt = <793750>;
-		};
+			opp-743000000 {
+				opp-hz = /bits/ 64 <743000000>;
+				opp-microvolt = <793750>, <893750>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 
-		opp-800000000 {
-			opp-hz = /bits/ 64 <800000000>;
-			opp-microvolt = <825000>;
+			opp-800000000 {
+				opp-hz = /bits/ 64 <800000000>;
+				opp-microvolt = <825000>, <925000>;
+				opp-core-mask = /bits/ 64 <0xf>;
+			};
 		};
-	};
 
 	pmu-a53 {
 		compatible = "arm,cortex-a53-pmu";
@@ -1278,18 +1301,6 @@ spi0: spi@1100a000 {
 			status = "disabled";
 		};
 
-		svs: svs@1100b000 {
-			compatible = "mediatek,mt8183-svs";
-			reg = <0 0x1100b000 0 0x1000>;
-			interrupts = <GIC_SPI 127 IRQ_TYPE_LEVEL_LOW>;
-			clocks = <&infracfg CLK_INFRA_THERM>;
-			clock-names = "main";
-			nvmem-cells = <&svs_calibration>,
-				      <&thermal_calibration>;
-			nvmem-cell-names = "svs-calibration-data",
-					   "t-calibration-data";
-		};
-
 		thermal: thermal@1100b000 {
 			#thermal-sensor-cells = <1>;
 			compatible = "mediatek,mt8183-thermal";
@@ -1426,6 +1437,18 @@ tztsABB: tztsABB {
 			};
 		};
 
+		svs: svs@1100b000 {
+			compatible = "mediatek,mt8183-svs";
+			reg = <0 0x1100b000 0 0x1000>;
+			interrupts = <GIC_SPI 127 IRQ_TYPE_LEVEL_LOW>;
+			clocks = <&infracfg CLK_INFRA_THERM>;
+			clock-names = "main";
+			nvmem-cells = <&svs_calibration>,
+				      <&thermal_calibration>;
+			nvmem-cell-names = "svs-calibration-data",
+					   "t-calibration-data";
+		};
+
 		pwm0: pwm@1100e000 {
 			compatible = "mediatek,mt8183-disp-pwm";
 			reg = <0 0x1100e000 0 0x1000>;
@@ -1855,14 +1878,24 @@ gpu: gpu@13040000 {
 				<GIC_SPI 278 IRQ_TYPE_LEVEL_LOW>;
 			interrupt-names = "job", "mmu", "gpu";
 
-			clocks = <&mfgcfg CLK_MFG_BG3D>;
-
 			power-domains =
 				<&spm MT8183_POWER_DOMAIN_MFG_CORE0>,
 				<&spm MT8183_POWER_DOMAIN_MFG_CORE1>,
 				<&spm MT8183_POWER_DOMAIN_MFG_2D>;
 			power-domain-names = "core0", "core1", "core2";
 
+
+			clocks =
+				<&topckgen CLK_TOP_MFGPLL_CK>,
+				<&topckgen CLK_TOP_MUX_MFG>,
+				<&clk26m>,
+				<&mfgcfg CLK_MFG_BG3D>;
+			clock-names =
+				"clk_main_parent",
+				"clk_mux",
+				"clk_sub_parent",
+				"subsys_mfg_cg";
+
 			operating-points-v2 = <&gpu_opp_table>;
 		};
 
-- 
2.41.0

